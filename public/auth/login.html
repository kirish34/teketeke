<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TekeTeke — Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f7fafc;margin:0;display:grid;place-items:center;height:100vh}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.06);padding:24px;min-width:320px;max-width:360px}
    h1{margin:0 0 12px;color:#111827;font-size:20px}
    .row{display:flex;flex-direction:column;margin:8px 0}
    input{padding:10px;border:1px solid #d1d5db;border-radius:8px}
    .btn{margin-top:8px;width:100%;padding:10px;border:none;border-radius:8px;background:#1976d2;color:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#6b7280;font-size:12px;margin-top:4px}
    .err{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:8px;padding:8px;margin-top:8px;display:none}
    .ok{background:#dcfce7;color:#064e3b;border:1px solid #86efac;border-radius:8px;padding:8px;margin-top:8px;display:none}
    .link{display:block;text-align:center;margin-top:10px;color:#1976d2;text-decoration:none}
  </style>
  <script src="/js/api.js"></script>
  <script src="/js/nav.js"></script>
  <script>
    // If already logged or a root token exists, route away quickly
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const existingAuth = localStorage.getItem('auth_token') || localStorage.getItem('TT_TOKEN');
        const hasRoot = localStorage.getItem('tt_root_token') || localStorage.getItem('tt_admin_token');
        if (existingAuth || hasRoot) {
          routeAfterLogin({ saccos: [] });
        }
      } catch {}
    });
  </script>
  </head>
<body>
  <div class="card">
    <h1>Sign in to TekeTeke</h1>
    <div class="row">
      <label>Email</label>
      <input id="email" type="email" placeholder="name@example.com" autocomplete="email" />
    </div>
    <div class="row">
      <label>Password</label>
      <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
    </div>
    <button id="loginBtn" class="btn">Sign in</button>
    <div id="msgErr" class="err"></div>
    <div id="msgOk" class="ok"></div>
    <a class="link" href="/auth/role-select.html">Choose role</a>
  </div>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const show = (el, txt)=>{ el.textContent = txt; el.style.display = 'block'; };
      const hide = (el)=> el.style.display = 'none';

      $('loginBtn').onclick = async ()=>{
        const btn = $('loginBtn');
        const errEl = $('msgErr'), okEl = $('msgOk');
        hide(errEl); hide(okEl);
        btn.disabled = true;

        try{
          const email = $('email').value.trim();
          const password = $('password').value.trim();
          if (!email || !password) { show(errEl, 'Email and password required'); btn.disabled=false; return; }

          const res = await TT.jpost('/api/auth/login', { email, password });
          if (res && res.access_token) {
            TT.setAuth(res.access_token);
          }
          show(okEl, 'Signed in. Redirecting…');
          routeAfterLogin(res || {});
        }catch(e){
          show(errEl, e.message || 'Login failed');
        }finally{
          btn.disabled = false;
        }
      };

      window.routeAfterLogin = function routeAfterLogin(session){
        const hasRoot = !!TT.getRoot();
        if (hasRoot) { location.href = '/admin.html'; return; }
        const saccos = Array.isArray(session.saccos) ? session.saccos : [];
        const isSaccoAdmin = saccos.some(r => {
          const role = String(r.role || '').toUpperCase();
          return role === 'SACCO_ADMIN' || role === 'ADMIN';
        });
        if (isSaccoAdmin) { location.href = '/sacco/admin.html'; return; }
        location.href = '/auth/role-select.html';
      }
    })();
  </script>
</body>
</html>
