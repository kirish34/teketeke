<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SACCO Staff Dashboard – TekeTeke</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#1976d2; --brand-700:#135ba1; --bg:#f5f8ff; --panel:#fff;
      --text:#0b0f19; --muted:#6b7280; --border:#e5e7eb; --ok:#065f46; --warn:#b45309;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0;padding:20px}
    h2{color:var(--brand);margin:0 0 12px}
    .top{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
    .pill{background:#eef6ff;border:1px solid #cfe3ff;border-radius:8px;padding:8px 10px;display:flex;gap:8px;align-items:center}
    input,select,button{padding:10px;border:1px solid var(--border);border-radius:8px}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    button.ghost{background:#fff;color:var(--brand)}
    .summary{background:#e3f2fd;color:#0d47a1;border:1px solid #cfe3ff;border-radius:10px;padding:12px;margin:10px 0;font-weight:700}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{background:var(--brand);color:#fff;position:sticky;top:0}
    .status-success{color:#065f46;font-weight:700}
    .status-pending{color:#b45309;font-weight:700}
    .status-failed{color:#b91c1c;font-weight:700}
    .mono{font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <h2>SACCO Staff Dashboard – TekeTeke</h2>

  <!-- SACCO selector / storage -->
  <div class="top">
    <div class="pill">
      <strong>SACCO ID</strong>
      <input id="sacco_id" placeholder="paste your SACCO UUID" style="min-width:280px">
      <button id="save_sacco">Save</button>
      <span id="save_state" class="muted"></span>
    </div>
    <div class="right muted">Tip: saved only in this browser.</div>
  </div>

  <!-- Summary bar -->
  <div class="summary">
    Total Collected Today (SACCO Fees → NET to Owner calc available in owner/sacco pages):
    KES <span id="totalToday">0.00</span>
  </div>

  <!-- Filters -->
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <label>Date <input type="date" id="dateFilter"></label>
      <label>Status
        <select id="statusFilter">
          <option value="">All</option>
          <option value="SUCCESS">Success</option>
          <option value="PENDING">Pending</option>
          <option value="FAILED">Failed</option>
        </select>
      </label>
      <input id="matatuSearch" placeholder="Search plate or ID…" />
      <label>Limit
        <select id="limit">
          <option>50</option>
          <option>100</option>
          <option>200</option>
        </select>
      </label>
      <button id="apply">Apply</button>
      <button class="ghost" id="clear">Clear</button>
      <span class="right muted" id="counts"></span>
    </div>
  </div>

  <!-- Table -->
  <div class="table-wrap card">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Matatu</th>
          <th>Fare (KES)</th>
          <th>Service Fee</th>
          <th>Status</th>
          <th>Txn ID</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const fmt = n => Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const todayISO = () => new Date().toISOString().slice(0,10);
  const startOf = (d)=> d+"T00:00:00.000Z";
  const endOf = (d)=> new Date(new Date(d).getTime()+24*60*60*1000).toISOString();

  // Persist sacco id locally
  function getSacco(){ return localStorage.getItem('tt_staff_sacco_id') || ''; }
  function setSacco(v){ localStorage.setItem('tt_staff_sacco_id', v); }

  // Existing API wrappers
  async function jget(url){
    const r = await fetch(url);
    const t = await r.text();
    if(!r.ok) throw new Error(t||r.statusText);
    return t ? JSON.parse(t) : {};
  }

  // Load summary for "today"
  async function loadTodayTotal(){
    const saccoId = getSacco();
    if (!saccoId){ $('totalToday').textContent = '0.00'; return; }
    const d = $('dateFilter').value || todayISO();
    // use ledger summary for the day (all types) then we show SACCO_FEE total as "collected" today
    const from = d, to = d; // server expects inclusive day via from/to
    const res = await jget(`/api/sacco/${encodeURIComponent(saccoId)}/summary?from=${from}&to=${to}`);
    const totals = res.totals || {};
    $('totalToday').textContent = fmt(totals.SACCO_FEE || 0);
  }

  // Load table of transactions
  async function loadTable(){
    const saccoId = getSacco();
    if (!saccoId){ $('tbody').innerHTML = `<tr><td colspan="6" class="muted">Set SACCO ID first.</td></tr>`; $('counts').textContent=''; return; }

    const limit = Number($('limit').value || 50);
    const status = $('statusFilter').value; // SUCCESS | PENDING | FAILED | ''
    const date  = $('dateFilter').value;    // optional
    const search= $('matatuSearch').value.trim().toUpperCase();

    let url = `/api/sacco/${encodeURIComponent(saccoId)}/transactions?limit=${limit}`;
    if (status) url += `&status=${encodeURIComponent(status)}`;

    const res = await jget(url);
    const items = (res.items || []).filter(row=>{
      // date filter (client-side; server returns ordered by created_at)
      if (date){
        const day = new Date(row.created_at).toISOString().slice(0,10);
        if (day !== date) return false;
      }
      // search by matatu id (uuid) only for now; plate can be added with a join later
      if (search){
        const mat = (row.matatu_id || '').toUpperCase();
        if (!mat.includes(search)) return false;
      }
      return true;
    });

    $('counts').textContent = `${items.length} row(s)`;
    const TB = $('tbody'); TB.innerHTML = '';
    items.forEach(r=>{
      const tr = document.createElement('tr');
      const s  = String(r.status||'').toUpperCase();
      const cls = s==='SUCCESS' ? 'status-success' : (s==='PENDING' ? 'status-pending' : 'status-failed');
      tr.innerHTML = `
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td class="mono">${r.matatu_id || ''}</td>
        <td>${fmt(r.fare_amount_kes || 0)}</td>
        <td>${fmt(r.service_fee_kes || 0)}</td>
        <td class="${cls}">${s}</td>
        <td class="mono">${r.id}</td>
      `;
      TB.appendChild(tr);
    });
  }

  // Events
  $('save_sacco').onclick = ()=>{
    const id = $('sacco_id').value.trim();
    if (!id) return;
    setSacco(id);
    $('save_state').textContent = 'saved ✓';
    setTimeout(()=> $('save_state').textContent = '', 1200);
    // refresh data after saving
    loadTodayTotal().catch(console.error);
    loadTable().catch(console.error);
  };
  $('apply').onclick = ()=> { loadTodayTotal().catch(console.error); loadTable().catch(console.error); };
  $('clear').onclick = ()=>{
    $('statusFilter').value = '';
    $('matatuSearch').value = '';
    $('dateFilter').value = todayISO();
    $('limit').value = '50';
    loadTodayTotal().catch(console.error);
    loadTable().catch(console.error);
  };

  // Init
  (function init(){
    $('sacco_id').value = getSacco();
    $('dateFilter').value = todayISO();
    loadTodayTotal().catch(console.error);
    loadTable().catch(console.error);
  })();
})();
</script>
</body>
</html>
